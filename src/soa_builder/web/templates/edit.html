{% extends 'base.html' %}
{% block content %}
<h2>Editing SoA {{ soa_id }}</h2>
<div class="flex">
  <div>
    <h3>Visits</h3>
    <ul>
      {% for v in visits %}
      <li>{{ v.order_index }}. {{ v.name }} ({{ v.raw_header }})
        <form hx-post="/ui/soa/{{ soa_id }}/delete_visit" hx-confirm="Delete visit '{{ v.name }}' and its cells?" style="display:inline">
          <input type="hidden" name="visit_id" value="{{ v.id }}" />
          <button type="submit" class="delete-btn">✕</button>
        </form>
      </li>
      {% endfor %}
    </ul>
    <form method="post" action="/ui/soa/{{ soa_id }}/add_visit">
      <input name="name" placeholder="Visit Name" required />
      <input name="raw_header" placeholder="Raw Header (optional)" />
      <button>Add Visit</button>
    </form>
  </div>
  <div>
    <h3>Activities</h3>
    <ul>
      {% for a in activities %}
      <li>{{ a.order_index }}. {{ a.name }}
        <form hx-post="/ui/soa/{{ soa_id }}/delete_activity" hx-confirm="Delete activity '{{ a.name }}' and its cells?" style="display:inline">
          <input type="hidden" name="activity_id" value="{{ a.id }}" />
          <button type="submit" class="delete-btn">✕</button>
        </form>
        <form method="post" action="/ui/soa/{{ soa_id }}/activity/{{ a.id }}/concepts" class="concept-form">
          <label style="font-size:0.8em;display:block;margin-top:4px;">Biomedical Concepts:
            <button type="button" onclick="refreshConcepts()" class="refresh-btn" title="Force reload concept list">↻</button>
          </label>
          {% if concepts_empty %}
          <div class="empty-concepts">No biomedical concepts loaded. Provide CDISC_API_KEY in .env or set CDISC_CONCEPTS_JSON override.</div>
          {% if concepts_diag %}
          <div class="concepts-diagnostics">
            <strong>Diagnostics</strong><br/>
            status: {{ concepts_diag.last_status if concepts_diag.last_status else 'n/a' }} | count: {{ concepts_diag.count }}<br/>
            api_key_present: {{ 'yes' if concepts_diag.api_key_present else 'no' }} | override_present: {{ 'yes' if concepts_diag.override_present else 'no' }} | skip_remote: {{ 'yes' if concepts_diag.skip_remote else 'no' }}<br/>
            {% if concepts_diag.last_error %}last_error: <code style="white-space:pre-wrap">{{ concepts_diag.last_error }}</code>{% endif %}
            {% if concepts_diag.raw_snippet %}<br/>raw_snippet:<code style="white-space:pre-wrap">{{ concepts_diag.raw_snippet }}</code>{% endif %}
            <a href="/concepts/status" target="_blank" style="font-size:0.7em;">raw status endpoint</a>
          </div>
          {% endif %}
          {% endif %}
          <select name="concept_codes" multiple size="6">
            {% for c in concepts %}
              {% set selected_list = activity_concepts.get(a.id, []) %}
              {% set codes = selected_list | map(attribute='code') | list %}
              <option value="{{ c.code }}" {% if c.code in codes %}selected{% endif %}>{{ c.title }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="small-btn">Save Concepts</button>
          {% if activity_concepts.get(a.id) %}
            <div class="concept-tags">
              {% for ac in activity_concepts.get(a.id) %}<span class="tag">{{ ac.title }}</span>{% endfor %}
            </div>
          {% endif %}
        </form>
      </li>
      {% endfor %}
    </ul>
    <form method="post" action="/ui/soa/{{ soa_id }}/add_activity">
      <input name="name" placeholder="Activity Name" required />
      <button>Add Activity</button>
    </form>
  </div>
</div>
<hr />
<h3>Matrix</h3>
<table class="matrix">
  <tr>
    <th>Activity \ Visit</th>
    {% for v in visits %}<th>{{ v.name }}</th>{% endfor %}
  </tr>
  {% for a in activities %}
  <tr>
    <td>{{ a.name }}</td>
  {% for v in visits %}
  {% set raw_status = cell_map.get((v.id, a.id), '') %}
  {% set display = 'X' if raw_status == 'X' else '' %}
  <td hx-post="/ui/soa/{{ soa_id }}/toggle_cell" hx-vals='{"visit_id": {{ v.id }}, "activity_id": {{ a.id }} }' hx-swap="outerHTML" class="cell">{{ display }}</td>
  {% endfor %}
  </tr>
  {% endfor %}
</table>
<p><a href="/soa/{{ soa_id }}/normalized" target="_blank">Generate Normalized Summary (JSON)</a></p>
<div class="export-buttons">
  <a class="btn" href="/soa/{{ soa_id }}/export/xlsx" title="Download Excel workbook">⬇ XLSX</a>
  <a class="btn" href="/soa/{{ soa_id }}/export/pdf" title="Download PDF matrix">⬇ PDF</a>
</div>
<style>
  .delete-btn { background:#c62828; color:#fff; border:none; padding:0 6px; cursor:pointer; }
  .delete-btn:hover { background:#b71c1c; }
  .export-buttons { margin-top:8px; }
  .export-buttons .btn { display:inline-block; margin-right:10px; background:#1976d2; color:#fff; padding:4px 10px; text-decoration:none; border-radius:3px; font-size:0.9em; }
  .export-buttons .btn:hover { background:#125aa0; }
  .concept-form { margin-top:4px; margin-bottom:6px; }
  .concept-form select { min-width:220px; }
  .small-btn { background:#2e7d32; color:#fff; border:none; padding:2px 8px; margin-top:4px; cursor:pointer; font-size:0.75em; }
  .small-btn:hover { background:#1b5e20; }
  .concept-tags { margin-top:4px; }
  .concept-tags .tag { display:inline-block; background:#eee; padding:2px 6px; margin:2px; border-radius:3px; font-size:0.7em; }
  .empty-concepts { background:#ffecb3; color:#795548; padding:4px 6px; border-radius:3px; font-size:0.7em; margin-bottom:4px; }
  .concepts-diagnostics { background:#f5f5f5; color:#333; padding:4px 6px; border-radius:3px; font-size:0.65em; margin-bottom:4px; border:1px solid #ddd; }
  .refresh-btn { background:#455a64; color:#fff; border:none; padding:2px 6px; margin-left:6px; cursor:pointer; font-size:0.7em; border-radius:3px; }
  .refresh-btn:hover { background:#263238; }
</style>
<script>
function refreshConcepts(){
  fetch('/ui/soa/{{ soa_id }}/concepts_refresh', {method:'POST'})
    .then(()=>window.location='/ui/soa/{{ soa_id }}/edit');
}
</script>
{% endblock %}
